<link rel="import" href="../tangere/tangere.html">


<style>

    .collapsed .expanded-only {
      display: none;
    }

    .expanded .collapsed-only {
      display:none;
    }

    .desktop .mobile-only {
      display:none;
    }

    .mobile .desktop-only {
      display:none;
    }

</style>


<script>
  Tangere.behaviors.taphandler = {

    listeners: {      
      'tap': '_tapHandler'
    },

    __getElementPath: function(element) {
      if (element == null) return [];
 
      var pathArr = [element];
 
      while(element.parentElement != null) {
        element = element.parentElement;
        pathArr.push(element);
      }
 
      return pathArr;
      },

    _tapHandler: function (e) {
 
      var p = e.path || this.__getElementPath(e.target), i = 0, n = null, src = null;

      if (!p || p.length == 0) return;

      for (var i = 0; i < p.length; i++) {
        n = p[i];
        if (n.getAttribute("tap-event") != null) {
          // found source node with tap-event attribute
          src = n;
          break;
        }

        // stop searching node tree "above" current card
        if (n == this) break;
      }

      // exit tap handler when no source node was found
      if (!src) return;

      var event = src.getAttribute("tap-event");
      var data = src.getAttribute("tap-event-data");

      if (event == "dialog") this._dialog(data);
      if (event == "container-mode") this._containerMode(data);
      
      // event is handled here, so stop propagation
      e.preventDefault();
      e.stopPropagation();
      return false;
    },

    _containerMode: function (data) {

      if (!this.$.container) return;

      this.toggleClass("expanded", data == "expanded", this.$.container);
      this.toggleClass("collapsed", data == "collapsed", this.$.container);

      this.fire('content-changed', this, { bubbles: true });

    },

    _dialog: function (data) {
  
      var args = (data || "").split("|");
      var dialog = args[0] || "dialog";

      var cardEl = this.tagName.toLowerCase();

      var p = cardEl.lastIndexOf("-card");
      if (p>0) {
        cardEl = cardEl.substring(0, p);
      }

      if (dialog.indexOf("/") > 0) {
        cardEl = dialog;
      } else {
        cardEl = cardEl + "/" + cardEl + "-" + dialog + "-card";
      }

      var compUrl = document.baseURI.indexOf("/components/") >= 0 ? "../" : "components/";
      if (window.ComponentsBase != undefined) compUrl = window.ComponentsBase;

      if (cardEl.indexOf(".html") != cardEl.length - 5) {
        cardEl += ".html";
      }

      var componentUrl = compUrl + cardEl;

      this.importHref(componentUrl, function () {

        var element = cardEl.substring(cardEl.indexOf("/") + 1).replace('.html', '');
        var cardComponent = document.createElement(element);

        if (cardComponent.properties && typeof cardComponent.properties.model != "undefined") {
          // share model 
          cardComponent.model = this.model;
        }

        var dialog = Polymer.dom(this.$.dialog);
        dialog.innerHTML = "";
        dialog.appendChild(cardComponent);
        Polymer.dom.flush();

        this.$.dialog.name = element;
        this.$.dialog.open();

      }, function (err) {
        var cn = err.target.href;
        var ok = confirm(window.location.href + "\n\nERROR: failed to load card " + cn);
      }, true);



    },

  };
</script>
